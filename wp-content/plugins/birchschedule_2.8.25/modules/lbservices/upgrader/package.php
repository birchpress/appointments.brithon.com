<?php

birch_ns( 'birchschedule.lbservices.upgrader', function( $ns ) {

        global $birchschedule;

        birch_defn( $ns, 'init', function() use( $ns, $birchschedule ) {

                birch_defmethod( $birchschedule, 'upgrade_module', 'lbservices', $ns->upgrade_module );

            } );

        birch_defn( $ns, 'upgrade_module', function() use( $ns ) {
                $ns->upgrade_1_0_to_1_1();
            } );

        birch_defn( $ns, 'get_db_version_location_based_services', function() {
                return get_option( 'birs_db_version_location_based_services', '1.0' );
            } );

        birch_defn( $ns, 'upgrade_1_0_to_1_1', function() use( $ns ) {
                global $birchpress;

                $version = $ns->get_db_version_location_based_services();
                if ( $version !== '1.0' ) {
                    return;
                }
                $services = $birchpress->db->query(
                    array(
                        'post_type' => 'birs_service'
                    ),
                    array(
                        'meta_keys' => array( '_birs_service_assigned_locations' ),
                        'base_keys' => array()
                    )
                );
                $locations = $birchpress->db->query(
                    array(
                        'post_type' => 'birs_location'
                    ),
                    array(
                        'meta_keys' => array(),
                        'base_keys' => array()
                    )
                );
                $assigned_locations = array();
                foreach ( $locations as $location_id => $location ) {
                    $assigned_locations[$location_id] = true;
                }
                $assigned_locations = serialize( $assigned_locations );
                foreach ( $services as $service_id => $service ) {
                    $service['_birs_service_assigned_locations'] = $assigned_locations;
                    $birchpress->db->save( $service, array(
                            'meta_keys' => array( '_birs_service_assigned_locations' ),
                            'base_keys' => array()
                        ) );
                }
                update_option( 'birs_db_version_location_based_services', '1.1' );
            } );

    } );
